# Azure DevOps Pipeline Template for prod-analyzer
#
# This template runs production configuration security scanning as a CI gate.
# Copy this file to azure-pipelines.yml in your repository root.
#
# Configuration:
# - PROFILE: Scan profile (spring, node, dotnet, or all)
# - ENVIRONMENT: Target environment name (prod, staging, etc.)
# - FAIL_ON: Minimum severity to block deployment (CRITICAL, HIGH, MEDIUM, LOW)
# - SCAN_TARGET: Directory to scan (default: current directory)

trigger:
  branches:
    include:
      - main
      - master
      - develop

pr:
  branches:
    include:
      - main
      - master
      - develop

pool:
  vmImage: "ubuntu-latest"

variables:
  PROFILE: "spring" # Change to: spring, node, dotnet, or all
  ENVIRONMENT: "prod" # Target environment name
  FAIL_ON: "HIGH" # Fail on: CRITICAL, HIGH, MEDIUM, or LOW
  SCAN_TARGET: "." # Directory to scan

stages:
  - stage: Build
    displayName: "Build Stage"
    jobs:
      - job: BuildJob
        displayName: "Build and Test"
        steps:
          - task: NodeTool@0
            displayName: "Install Node.js"
            inputs:
              versionSpec: "20.x"

          - script: npm ci
            displayName: "Install dependencies"

          - script: npm run build
            displayName: "Build project"

          - script: npm test
            displayName: "Run tests"

          - publish: $(System.DefaultWorkingDirectory)/dist
            artifact: dist
            displayName: "Publish build artifacts"

  - stage: Security
    displayName: "Security Scan Stage"
    dependsOn: Build
    jobs:
      - job: SecurityScan
        displayName: "Production Config Security Scan"
        steps:
          - task: NodeTool@0
            displayName: "Install Node.js"
            inputs:
              versionSpec: "20.x"

          - download: current
            artifact: dist
            displayName: "Download build artifacts"

          - script: npm ci
            displayName: "Install dependencies"

          - script: |
              echo "Running production configuration security scan"
              echo "Profile: $(PROFILE), Environment: $(ENVIRONMENT), Fail on: $(FAIL_ON)"
              npx prod-analyzer scan \
                --directory $(SCAN_TARGET) \
                --profile $(PROFILE) \
                --env $(ENVIRONMENT) \
                --fail-on $(FAIL_ON)
            displayName: "Run prod-analyzer security scan"

          # Optional: Generate JSON report
          - script: |
              npx prod-analyzer scan \
                --directory $(SCAN_TARGET) \
                --profile $(PROFILE) \
                --format json > $(Build.ArtifactStagingDirectory)/prod-analyzer-results.json
            displayName: "Generate JSON report"
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: "Publish security scan results"
            condition: always()
            inputs:
              PathtoPublish: "$(Build.ArtifactStagingDirectory)/prod-analyzer-results.json"
              ArtifactName: "security-scan-results"
              publishLocation: "Container"
