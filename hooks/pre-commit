#!/bin/bash
# ==============================================================================
# Secure Guard Pre-commit Hook
# ==============================================================================
# This hook runs before every commit to catch security issues early.
#
# Installation:
#   cp hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use Husky:
#   npm install --save-dev husky
#   npx husky install
#   npx husky add .git/hooks/pre-commit "bash hooks/pre-commit"
# ==============================================================================

set -e

echo "üîç Running Secure Guard security scan..."

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if secure-guard is available
if ! command -v secure-guard &> /dev/null && [ ! -f "dist/cli/main.js" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Secure Guard not found. Skipping security scan.${NC}"
    echo -e "${YELLOW}üí° Install with: npm install -g secure-guard${NC}"
    exit 0
fi

# Determine command
if command -v secure-guard &> /dev/null; then
    CMD="secure-guard scan"
elif [ -f "dist/cli/main.js" ]; then
    CMD="node dist/cli/main.js scan"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Cannot find secure-guard. Skipping.${NC}"
    exit 0
fi

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(yml|yaml|properties|json|env)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úÖ No config files changed. Skipping security scan.${NC}"
    exit 0
fi

echo "üìÑ Checking ${STAGED_FILES}"

# Run scan with CRITICAL threshold (don't block on lower severity)
# Use --fail-on CRITICAL to only block for critical issues
if $CMD --fail-on CRITICAL; then
    echo -e "${GREEN}‚úÖ Security scan passed${NC}"
    exit 0
else
    EXIT_CODE=$?
    
    if [ $EXIT_CODE -eq 1 ]; then
        echo ""
        echo -e "${RED}‚ùå CRITICAL security issues found!${NC}"
        echo -e "${RED}   Commit blocked for your protection.${NC}"
        echo ""
        echo -e "${YELLOW}üí° To see details, run:${NC}"
        echo -e "   ${YELLOW}$CMD --verbose${NC}"
        echo ""
        echo -e "${YELLOW}üí° To bypass (NOT RECOMMENDED):${NC}"
        echo -e "   ${YELLOW}git commit --no-verify${NC}"
        echo ""
        exit 1
    else
        echo -e "${RED}‚ùå Security scan failed with error code: $EXIT_CODE${NC}"
        exit $EXIT_CODE
    fi
fi
